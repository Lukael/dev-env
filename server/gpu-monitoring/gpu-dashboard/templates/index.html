<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GPU Dashboard</title>
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            margin: 20px;
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .gpu-section {
            margin-top: 10px;
        }

        .gpu-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            margin: 6px 0;
        }

        .gpu-divider {
            border-top: 1px dashed #e5e5e5;
            margin: 10px 0 6px;
        }

        .gpu-bar-chart {
            margin: 6px 0 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .gpu-bar-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gpu-bar-label {
            width: 64px;
            text-align: right;
            font-weight: 600;
            font-size: 12px;
        }

        .gpu-bar-track {
            flex: 1;
            background: #f5f5f5;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
            position: relative;
        }

        .gpu-bar-fill {
            background: #6aa9ff;
            height: 100%;
            border-radius: 8px;
            min-width: 2px;
        }

        .gpu-bar-fill.bad {
            background: #f39;
        }

        .gpu-bar-meta {
            font-size: 12px;
            color: #555;
            min-width: 140px;
            text-align: right;
        }

        .toggle-btn {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #fafafa;
            cursor: pointer;
            font-size: 12px;
        }

        .toggle-btn:hover {
            background: #f0f0f0;
        }

        .muted {
            color: #666;
            font-size: 12px;
        }

        input {
            padding: 8px 10px;
            border-radius: 10px;
            border: 1px solid #ddd;
            min-width: 280px;
        }

        .server-section {
            margin-top: 18px;
        }

        .server-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
        }

        .server-title {
            font-size: 16px;
            font-weight: 700;
        }

        .server-meta {
            font-size: 12px;
            color: #666;
        }

        .divider {
            border-top: 1px solid #eaeaea;
            margin: 14px 0 12px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            table-layout: fixed;
        }

        th,
        td {
            border-bottom: 1px solid #eee;
            padding: 8px 10px;
            text-align: left;
            font-size: 14px;
            word-break: break-word;
            white-space: normal;
        }

        th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
        }

        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            border: 1px solid #ddd;
            font-size: 12px;
        }

        .bad {
            border-color: #f3b;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .empty {
            padding: 10px 0;
            color: #666;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <h2>GPU Process Dashboard</h2>

    <div class="row">
        <div class="card">
            <div><b>Status</b></div>
            <div class="muted" id="status">Loading...</div>
        </div>

        <div class="card">
            <div><b>Refresh</b></div>
            <div class="muted">Auto refresh every <span id="intervalLabel">5</span>s</div>
        </div>

        <div class="card" style="flex: 1;">
            <div><b>Filter</b></div>
            <div class="muted">Search server/container/user/process</div>
            <input id="q" placeholder="e.g., oisl0 or training or root or appuser" />
        </div>
    </div>

    <div id="content"></div>

    <script>
        const REFRESH_SEC = 5;
        const openDetails = new Set(); // server -> expanded state
        document.getElementById("intervalLabel").textContent = REFRESH_SEC;

        function esc(s) {
            return String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
        }

        function slugifyId(s) {
            return String(s || "unknown").replace(/[^A-Za-z0-9_-]/g, "-");
        }

        function groupByServer(rows) {
            const g = {};
            for (const r of rows) {
                const server = r.server || "unknown";
                (g[server] = g[server] || []).push(r);
            }
            return g;
        }

        function summarize(rows) {
            // Best-effort summary per server
            const containers = new Set();
            let maxUtil = 0;
            let totalVram = 0;

            for (const r of rows) {
                if (r.container) containers.add(r.container);
                const util = Number(r.gpu_util ?? 0);
                const vram = Number(r.vram_mb ?? 0);
                if (util > maxUtil) maxUtil = util;
                if (Number.isFinite(vram)) totalVram += vram;
            }
            return { containers: containers.size, maxUtil, totalVram };
        }

        function renderServerTable(server, rows) {
            const { containers, maxUtil, totalVram } = summarize(rows);
            const detailId = `gpu-details-${slugifyId(server)}`;
            const isOpen = openDetails.has(server);

            const header = `
      <div class="server-header">
        <div class="server-title">${esc(server)}</div>
        <div class="server-meta">
          Rows: <span class="mono">${rows.length}</span>
        </div>
      </div>
    `;

            if (!rows.length) {
                return `
        <div class="server-section">
          ${header}
          <div class="divider"></div>
          <div class="empty">No GPU compute processes found.</div>
        </div>
      `;
            }

            const byGpu = {};
            for (const r of rows) {
                const idx = r.gpu_idx ?? "";
                (byGpu[idx] = byGpu[idx] || []).push(r);
            }

            const gpuIdxs = Object.keys(byGpu).sort((a, b) => {
                const na = Number(a);
                const nb = Number(b);
                if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb;
                return String(a).localeCompare(String(b));
            });

            const gpuStats = gpuIdxs.map(gpu => {
                const gpuRows = byGpu[gpu];
                const stat = gpuRows.reduce(
                    (acc, r) => {
                        const used = Number(r.used_mem ?? 0);
                        const total = Number(r.total_vram ?? 0);
                        if (Number.isFinite(used) && used > acc.used) acc.used = used;
                        if (Number.isFinite(total) && total > acc.total) acc.total = total;
                        return acc;
                    },
                    { used: 0, total: 0 }
                );
                const pct = stat.total > 0 ? Math.round((stat.used / stat.total) * 100) : 0;
                return { gpu, used: stat.used, total: stat.total, pct };
            });

            const maxTotalVram = gpuStats.reduce((m, s) => (s.total > m ? s.total : m), 0) || 1;

            const barChart = `
        <div class="gpu-bar-chart">
          ${gpuStats.map(s => {
                const widthPct = Math.min(100, Math.round((s.used / maxTotalVram) * 100));
                return `
            <div class="gpu-bar-row" aria-label="GPU ${esc(s.gpu === "" ? "?" : s.gpu)} VRAM ${s.used}/${s.total} MB">
              <div class="gpu-bar-label">GPU ${esc(s.gpu === "" ? "?" : s.gpu)}</div>
              <div class="gpu-bar-track">
                <div class="gpu-bar-fill ${s.pct >= 80 ? 'bad' : ''}" style="width:${widthPct}%;"></div>
              </div>
              <div class="gpu-bar-meta mono">${s.used}/${s.total} MB${s.total > 0 ? ` (${s.pct}%)` : ""}</div>
            </div>
          `;
            }).join("")}
        </div>
      `;

            const gpuSections = gpuIdxs.map((gpu, i) => {
                const gpuRows = byGpu[gpu];
                // Sort within GPU: highest util then highest vram
                gpuRows.sort((a, b) => (Number(b.gpu_util ?? 0) - Number(a.gpu_util ?? 0)) ||
                    (Number(b.vram_mb ?? 0) - Number(a.vram_mb ?? 0)));

                const vramStat = gpuStats.find(s => s.gpu === gpu) || { used: 0, total: 0, pct: 0 };

                const body = gpuRows.map(r => {
                    const util = Number(r.gpu_util ?? 0);
                    const vram = Number(r.vram_mb ?? 0);
                    const utilBadge = `<span class="pill ${util >= 80 ? 'bad' : ''}">${util}</span>`;
                    const vramBadge = `<span class="pill ${vram >= 20000 ? 'bad' : ''}">${vram}</span>`;
                    return `
            <tr>
              <td class="mono">${esc(gpu === "" ? "?" : gpu)}</td>
              <td class="mono">${esc(r.pid ?? "")}</td>
              <td>${esc(r.container ?? "")}</td>
              <td><b>${esc(r.container_user ?? "")}</b></td>
              <td>${esc(r.process ?? "")}</td>
              <td>${utilBadge}</td>
              <td>${vramBadge}</td>
            </tr>
          `;
                }).join("");

                return `
        <div class="gpu-section">
          <div class="gpu-header">
            <div>GPU <span class="mono">${esc(gpu === "" ? "?" : gpu)}</span></div>
          </div>
          <table>
            <colgroup>
              <col style="width:8%;">
              <col style="width:10%;">
              <col style="width:22%;">
              <col style="width:15%;">
              <col style="width:25%;">
              <col style="width:10%;">
              <col style="width:10%;">
            </colgroup>
            <thead>
              <tr>
                <th>GPU</th>
                <th>PID</th>
                <th>Container</th>
                <th>Container User</th>
                <th>Process</th>
                <th>GPU Util (%)</th>
                <th>VRAM (MB)</th>
              </tr>
            </thead>
            <tbody>${body}</tbody>
          </table>
        </div>
        ${i === gpuIdxs.length - 1 ? "" : '<div class="divider gpu-divider"></div>'}
      `;
            }).join("");

            return `
      <div class="server-section">
        ${header}
        <div class="divider"></div>

        ${barChart}
        <div style="margin: 6px 0 4px;">
          <button class="toggle-btn" data-target="${detailId}" data-server="${esc(server)}">${isOpen ? "Hide GPU tables" : "Show GPU tables"}</button>
        </div>
        <div id="${detailId}" class="gpu-details" style="${isOpen ? "" : "display: none;"}">
          ${gpuSections}
        </div>
      </div>
    `;
        }

        function renderAll(rows) {
            const q = document.getElementById("q").value.trim().toLowerCase();
            const filtered = !q ? rows : rows.filter(r => {
                const s = `${r.server} gpu${r.gpu_idx} ${r.container} ${r.container_user} ${r.user} ${r.process} ${r.pid}`.toLowerCase();
                return s.includes(q);
            });

            const groups = groupByServer(filtered);
            const servers = Object.keys(groups).sort();

            const html = servers.map(s => renderServerTable(s, groups[s])).join("");
            document.getElementById("content").innerHTML = html || `<div class="empty">No matching rows.</div>`;

            // Attach toggle handlers after render
            document.querySelectorAll(".toggle-btn").forEach(btn => {
                btn.onclick = () => {
                    const targetId = btn.dataset.target;
                    const server = btn.dataset.server;
                    const el = document.getElementById(targetId);
                    if (!el || !server) return;
                    const hidden = el.style.display === "none";
                    el.style.display = hidden ? "" : "none";
                    btn.textContent = hidden ? "Hide GPU tables" : "Show GPU tables";
                    if (hidden) {
                        openDetails.add(server);
                    } else {
                        openDetails.delete(server);
                    }
                };
            });
        }

        function formatKst(utcTs) {
            const d = new Date(utcTs);
            if (Number.isNaN(d.getTime())) return utcTs ?? "";
            const pad = (n) => String(n).padStart(2, "0");
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        async function tick() {
            const status = document.getElementById("status");
            try {
                const res = await fetch("/api/metrics", { cache: "no-store" });
                const data = await res.json();

                const okCount = (data.servers || []).filter(s => s.ok).length;
                const total = (data.servers || []).length;
                status.textContent = `Last update: ${formatKst(data.ts_utc)} (KST) | Servers OK: ${okCount}/${total} | Rows: ${(data.rows || []).length}`;

                renderAll(data.rows || []);
            } catch (e) {
                status.textContent = `Error: ${e}`;
            }
        }

        document.getElementById("q").addEventListener("input", () => tick());
        tick();
        setInterval(tick, REFRESH_SEC * 1000);
    </script>
</body>

</html>